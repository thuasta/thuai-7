asyncapi: 3.0.0
info:
  title: THUAI7 API
  version: 'v0.1.0'
  description: |
    Copyright (c) 2024 Student Association of Science and Technology, Department of Automation, Tsinghua University

    API for THUAI7.

channels:
  /competition/control:
    description: Channel for recorder to generate record files. Skip this part if you are a player.
    address: /competition/control
    messages:
      Error:
        $ref: '#/components/messages/Error'
      CompetitionUpdate:
        $ref: '#/components/messages/CompetitionUpdate'
      Map:
        $ref: '#/components/messages/Map'
      Supplies:
        $ref: '#/components/messages/Supplies'
      SafeZone:
        $ref: '#/components/messages/SafeZone'

  /competition/player:
    description: Channel for player to get information and perform actions.
    address: /competition/player
    messages:
      PlayerPerform:
         $ref: '#/components/messages/PlayerPerform'
      Error:
        $ref: '#/components/messages/Error'
      PlayersInfo:
        $ref: '#/components/messages/PlayersInfo'
      Map:
        $ref: '#/components/messages/Map'
      Supplies:
        $ref: '#/components/messages/Supplies'
      SafeZone:
        $ref: '#/components/messages/SafeZone'

operations:
  /competition/control.publish:
    action: receive
    channel:
      $ref: '#/channels/~1competition~1control'
    messages:
      - $ref: '#/channels/~1competition~1control/messages/Error'

  /competition/control.subscribe:
    action: send
    channel:
      $ref: '#/channels/~1competition~1control'
    messages:
      - $ref: '#/channels/~1competition~1control/messages/Error'
      - $ref: '#/channels/~1competition~1control/messages/CompetitionUpdate'
      - $ref: '#/channels/~1competition~1control/messages/Map'
      - $ref: '#/channels/~1competition~1control/messages/Supplies'
      - $ref: '#/channels/~1competition~1control/messages/SafeZone'
  
  /competition/player.publish:
    action: receive
    channel:
      $ref: '#/channels/~1competition~1player'
    messages:
      - $ref: '#/channels/~1competition~1player/messages/PlayerPerform'

  /competition/player.subscribe:
    action: send
    channel:
      $ref: '#/channels/~1competition~1player'
    messages:
      - $ref: '#/channels/~1competition~1player/messages/Error'
      - $ref: '#/channels/~1competition~1player/messages/PlayersInfo'
      - $ref: '#/channels/~1competition~1player/messages/Map'
      - $ref: '#/channels/~1competition~1player/messages/Supplies'
      - $ref: '#/channels/~1competition~1player/messages/SafeZone'

components:
  messages:
    PlayersInfo:
      title: PlayersInfo
      description: Information of all players
      payload:
        type: object
        required:
          - messagetype
          - players
        properties:
          messageType:
            type: string
            const: PLAYERS_INFO
          players:
            type: array
            additionalProperties: false
            required:
              - playerId
              - armor
              - health
              - speed
              - firearm
              - position
              - inventory
            properties:
              playerId:
                type: integer
              armor:
                type: string
                enum:
                  - NO_ARMOR
                  - PRIMARY_ARMOR
                  - PREMIUM_ARMOR
              health:
                type: integer
              speed:
                type: number
              firearm:
                type: object
                required:
                  - name
                  - distance
                properties:
                  name:
                    type: string
                    enum:
                      - S686
                      - VECTOR
                      - M16
                      - AWM
                  distance:
                    type: number
              position:
                $ref: '#/components/schemas/Position'
              inventory:
                type: array
                items:
                  type: object
                  required:
                    - name
                    - num
                  properties:
                    name:
                      type: string
                      enum:
                        - BULLET
                        - FIRST_AID
                        - BANDAGE
                        - GRENADE
                    num:
                      type: integer

    CompetitionUpdate:
      title: CompetitionUpdate
      description: Information of the game in one tick
      payload:
        type: object
        additionalProperties: false
        required:
          - messageType
          - currentTicks
          - players
          - events
        properties:
          messageType:
            type: string
            const: COMPETITION_UPDATE
          currentTicks:
            type: integer
          info:
            type: string
            additionalProperties: false
            required:
              - stage
            properties:
              stage:
                type: string
                enum:
                  - READY
                  - RUNNING
                  - FINISHED
                  - ENDED
          players:
            type: array
            additionalProperties: false
            required:
              - playerId
              - armor
              - health
              - speed
              - firearm
              - inventory
              - position
            properties:
              playerId:
                type: integer
              armor:
                type: string
                enum:
                  - NO_ARMOR
                  - PRIMARY_ARMOR
                  - PREMIUM_ARMOR
              health:
                type: integer
              speed:
                type: number
              firearm:
                type: object
                required:
                  - name
                  - distance
                properties:
                  name:
                    type: string
                    enum:
                      - S686
                      - VECTOR
                      - M16
                      - AWM
                  distance:
                    type: number
              inventory:
                type: array
                items:
                  type: object
                  required:
                    - name
                    - numb
                  properties:
                    name:
                      type: string
                      enum:
                        - BULLET
                        - FIRST_AID
                        - BANDAGE
                        - GRENADE
                    num:
                      type: integer
              position:
                $ref: '#/components/schemas/Position'
          events:
            type: array
            items:
              oneOf:
                - $ref: '#/components/schemas/PlayerAttackEvent'
                - $ref: '#/components/schemas/PlayerSwitchArmEvent'
                - $ref: '#/components/schemas/PlayerPickUpEvent'
                - $ref: '#/components/schemas/PlayerUseMedicineEvent'
                - $ref: '#/components/schemas/PlayerUseGrenadeEvent'
                - $ref: '#/components/schemas/PlayerAbandonEvent'
                - $ref: '#/components/schemas/PlayerPrepareEvent'

    PlayerPerform:
      title: PlayerPerform
      description: Player's action
      payload:
        type: array
        items:
          oneOf:
            - $ref: '#/components/schemas/PerformAbandon'
            - $ref: '#/components/schemas/PerformPickUp'
            - $ref: '#/components/schemas/PerformSwitchArm'
            - $ref: '#/components/schemas/PerformUseMedicine'
            - $ref: '#/components/schemas/PerformUseGrenade'
            - $ref: '#/components/schemas/PerformMove'
            - $ref: '#/components/schemas/PerformStop'
            - $ref: '#/components/schemas/PerformAttack'
            - $ref: '#/components/schemas/GetPlayerInfo'
            - $ref: '#/components/schemas/GetMap'
            - $ref: '#/components/schemas/ChooseOrigin'

    Map:
      title: Map
      description: Information of the map
      payload:
        type: object
        additionalProperties: false
        required:
          - messageType
          - length
          - walls
        properties:
          messageType:
            type: string
            const: MAP
          length:
            type: integer
          walls:
            type: array
            items:
              type: object
              required:
                - wallPositions
              properties:
                wallPositions:
                  $ref: '#/components/schemas/PositionInt'

    SafeZone:
      title: SafeZone
      description: Information of the safe zone
      payload:
        type: object
        required:
          - messageType
          - center
          - radius
        properties:
          messageType:
            type: string
            const: SAFE_ZONE
          center:
            $ref: '#/components/schemas/Position'
          radius:
            type: number

    Supplies:
      title: Supplies
      description: Information of the supplies
      payload:
        type: object
        required:
          - messageType
          - supplies
        properties:
          messageType:
            type: string
            const: SUPPLIES
          supplies:
            type: array
            items:
              type: object
              required:
                - name
                - position
                - numb
              properties:
                name:
                  type: integer
                  enum:
                    - BULLET
                    - FIRST_AID
                    - BANDAGE
                     
                    - GRENADE
                    - PRIMARY_ARMOR
                    - PREMIUM_ARMOR
                    - S686
                    - VECTOR
                    - M16
                    - AWM
                position:
                  $ref: '#/components/schemas/Position'
                numb:
                  type: integer
          
    Error:
      title: Error
      description: Error message
      payload:
        type: object
        additionalProperties: false
        required:
          - messageType
          - errorCode
          - message
        properties:
          messageType:
            type: string
            const: ERROR
          errorCode:
            type: integer
          message:
            type: string

  schemas:
    ChooseOrigin:
      title: ChooseOrigin
      description: Choose a position as the origin
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - originPosition
      properties:
        messageType:
          type: string
          const: CHOOSE_ORIGIN
        token:
          type: string
        originPosition:
          $ref: '#/components/schemas/Position'

    GetMap:
      title: GetMap
      description: Get the map
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
      properties:
        messageType:
          type: string
          const: GET_MAP
        token:
          type: string

    GetPlayerInfo:
      title: GetPlayerInfo
      description: Get the player's information
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
      properties:
        messageType:
          type: string
          const: GET_PLAYER_INFO
        token:
          type: string

    PerformAttack:
      title: PerformAttack
      description: Attack the target position
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - targetPosition
      properties:
        messageType:
          type: string
          const: PERFORM_ATTACK
        token:
          type: string
        targetPosition:
          $ref: '#/components/schemas/Position'

    PerformMove:
      title: PerformMove
      description: Move to the destination
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - destination
      properties:
        messageType:
          type: string
          const: PERFORM_MOVE
        token:
          type: string
        destination:
          $ref: '#/components/schemas/Position'

    PerformStop:
      title: PerformStop
      description: Stop moving
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
      properties:
        messageType:
          type: string
          const: PERFORM_STOP
        token:
          type: string

    PerformUseGrenade:
      title: PerformUseGrenade
      description: Use grenade to the target position
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - targetPosition
      properties:
        messageType:
          type: string
          const: PERFORM_USE_GRENADE
        token:
          type: string
        targetPosition:
          $ref: '#/components/schemas/Position'

    PerformUseMedicine:
      title: PerformUseMedicine
      description: Use medicine
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - medicineName
      properties:
        messageType:
          type: string
          const: PERFORM_USE_MEDICINE
        token:
          type: string
        medicineName:
          type: string
          enum:
             
            - BANDAGE
            - FIRST_AID

    PerformSwitchArm:
      title: PerformSwitchArm
      description: Switch to the target firearm
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - targetFirearm
      properties:
        messageType:
          type: string
          const: PERFORM_SWITCH_ARM
        token:
          type: string
        targetFirearm:
          type: string
          enum:
            - S686
            - VECTORY
            - AWM
            - M16

    PerformPickUp:
      title: PerformPickUp
      description: Pick up the target supply
      type: object
      additionalProperties: false
      required:
        - messageType
        - token
        - targetSupply
        - targetPosition
        - num
      properties:
        messageType:
          type: string
          const: PERFORM_PICK_UP
        token:
          type: string
        targetSupply:
          type: string
          enum:
            - S686
            - VECTORY
            - AWM
            - M16
            - BULLET
            - BANDAGE
            - PRIMARY_ARMOR
            - PREMIUM_ARMOR
            - FIRST_AID
            - GRENADE
        num:
          type: integer 
        targetPosition:
          $ref: '#/components/schemas/Position'

    PerformAbandon:
      title: PerformAbandon
      description: Abandon the target supply
      type: object
      additionalProperties: false
      required:
          - messageType
          - token
          - targetSupply
          - numb
      properties:
        messageType:
          type: string
          const: PERFORM_ABANDON
        numb:
          type: integer
        token:
          type: string
        targetSupply:
          type: string
          enum:
            - S686
            - VECTORY
            - AWM
            - M16
            - BULLET
            - BANDAGE
            - PRIMARY_ARMOR
            - PREMIUM_ARMOR
            - FIRST_AID
            - GRENADE

    PlayerAttackEvent:
      title: PlayerAttackEvent
      description: Happens when a player successfully attacks
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetPosition
      properties:
        eventType:
          type: string
          const: PLAYER_ATTACK
        playerId:
          type: integer
        targetPosition:
          $ref: '#/components/schemas/Position'

    PlayerPrepareEvent:
      title: PlayerPrepareEvent
      description: I don't know. This event is created by someone else.
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetPosition
      properties:
        eventType:
          type: string
          const: PLAYER_PREPARE
        playerId:
          type: integer
        targetPosition:
          $ref: '#/components/schemas/Position'

    PlayerSwitchArmEvent:
      title: PlayerSwitchArmEvent
      description: Happens when a player successfully switches firearm
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetFirearm
      properties:
        eventType:
          type: string
          const: PLAYER_SWITCH_ARM
        playerId:
          type: integer
        targetFirearm:
          type: string
          enum:
            - S686
            - VECTORY
            - AWM
            - M16

    PlayerPickUpEvent:
      title: PlayerPickUpEvent
      description: Happens when a player successfully picks up a supply
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetSupply
        - targetPosition
        - numb
      properties:
        eventType:
          type: string
          const: PLAYER_PICK_UP
        playerId:
          type: integer
        targetSupply:
          type: string
          enum:
            - BULLET
            - FIRST_AID
            - BANDAGE
             
            - GRENADE
            - PRIMARY_ARMOR
            - PREMIUM_ARMOR
            - S686
            - VECTOR
            - M16
            - AWM
        targetPosition:
          $ref: '#/components/schemas/Position'
        numb:
          type: integer

    PlayerUseMedicineEvent:
      title: PlayerUseMedicineEvent
      description: Happens when a player successfully uses medicine
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetMedicine
      properties:
        eventType:
          type: string
          const: PLAYER_USE_MEDICINE
        playerId:
          type: integer
        targetMedicine:
          type: string
          enum:
            - FIRST_AID
            - BANDAGE
             
    PlayerUseGrenadeEvent:
      title: PlayerUseGrenadeEvent
      description: Happens when a player successfully uses grenade
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetPosition
      properties:
        eventType:
          type: string
          const: PLAYER_USE_GRENADE
        playerId:
          type: integer
        targetPosition:
          $ref: '#/components/schemas/Position'

    PlayerAbandonEvent:
      title: PlayerAbandonEvent
      description: Happens when a player successfully abandons supplies
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - abandonedSupplies
        - numb
      properties:
        eventType:
          type: string
          const: PLAYER_ABANDON
        playerId:
          type: integer
        numb:
          type: integer
        abandonedSupplies:
          type: string
          required:
            - name
          properties:
            name:
              type: string
              enum:
                - BULLET
                - FIRST_AID
                - BANDAGE
                - GRENADE
                - PRIMARY_ARMOR
                - PREMIUM_ARMOR
                - S686
                - VECTOR
                - M16
                - AWM

    Position:
      title: Position
      description: Refers to a position with real number coordinates
      type: object
      additionalProperties: false
      required:
        - x
        - y
      properties:
        x:
          type: number
        y:
          type: number

    PositionInt:
      title: PositionInt
      description: Refers to a position with integer coordinates
      type: object
      additionalProperties: false
      required:
        - x
        - y
      properties:
        x:
          type: integer
        y:
          type: integer
